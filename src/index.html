<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.js"></script>
  <script src="TLE.js"></script> 

  <!-- css -->
  <link rel="stylesheet" href="/src/css/infobox.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/src/css/main.css" type="text/css" media="screen, projection" />
</head>
<body>
  <div id="loading">
   <h1>Satellite Visualizer</h1>
  </div>
  <div id="cesiumContainer"></div>
  
  <script>
    // Initialize Cesium viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.TileMapServiceImageryProvider({
        url: Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII"),
      }),
      baseLayerPicker: false, geocoder: false, homeButton: true, infoBox: true,
      navigationHelpButton: false, sceneModePicker: true
    });

    // viewer.infoBox.frame.removeAttribute('sandbox');
    viewer.scene.globe.enableLighting = true;
    // var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);

    var satellitePoint;
    var dataset_size = activeSattelites.length;
    var i = 0;
    var j = 0; // Track name of elements in activeSatellites

    for(i=0; i < dataset_size; i+=3) { // Loop through each satellite's TLE
      var tle1 = activeSattelites[i+1];
      var tle2 = activeSattelites[i+2];

      if(typeof tle1 == 'string' || typeof tle2 == 'string') {
        var satrec = satellite.twoline2satrec(tle1, tle2); // Initialize satellite record
      }

    
      const totalSeconds = 7200; // Sample points up to 8 hours from current date
      const timestepInSeconds = 10; // Generate a new position every 10 seconds

      const start = Cesium.JulianDate.fromDate(new Date());
      const stop = Cesium.JulianDate.addSeconds(start, totalSeconds, new Cesium.JulianDate());
      
      // Our timeline begins from current time and extends 8 hours ahead, with a default
      // time multipler of 5x, which can be changed
      viewer.clock.startTime = start.clone();
      viewer.clock.stopTime = stop.clone();
      viewer.clock.currentTime = start.clone();
      viewer.timeline.zoomTo(start, stop);
      viewer.clock.multiplier = 5;
      viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
      
      const positionsOverTime = new Cesium.SampledPositionProperty();
      
      // Give SatelliteJS the TLE's and a specific time.
      // Get back a longitude, latitude, height (km).
      for (let i = 0; i < totalSeconds; i+= timestepInSeconds) {
        const time = Cesium.JulianDate.addSeconds(start, i, new Cesium.JulianDate());
        const jsDate = Cesium.JulianDate.toDate(time);

        const positionAndVelocity = satellite.propagate(satrec, jsDate);
        const gmst = satellite.gstime(jsDate);
        const p = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

        const position = Cesium.Cartesian3.fromRadians(p.longitude, p.latitude, p.height * 1000);
        positionsOverTime.addSample(time, position);
      }
      
        if(j == 0) { // International Space Station
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 10, color: Cesium.Color.DARKMAGENTA}
          });
        }

        else if(j >= 3 && j <= 5346) { // Starlink (Comm)
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.GREEN}
          });
        }

        else if(j >= 5349 && j <= 5529) { // Space & Earth Science
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.YELLOW}
          });
        }

        else if(j >= 5532 && j <= 6486) { // IRIDIUM 33 Debris
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.RED}
          });
        }

        else if(j >= 6489 && j <= 6960) { // GNSS (Global Navigation Satellite Systems)
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.DODGERBLUE}
          });
        }

        else if(j >= 6963 && j <= 14883) { // FENGYUN 1C Debris
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.RED}
          });
        }

        else if(j >= 14886 && j <= 15201) { // Iridium & Iridium NEXT (Comm)
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.GREEN}
          });
        }

        else if(j >= 15204 && j <= 18036) { // GEO Protected Zone (Comm)
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.GREEN}
          });
        }
        
        else if(j >= 18039 && j <= 21141) { // COSMOS 2251 Debris
          satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 2.0, 2.0e7, 0.5), 
              pixelSize: 3, color: Cesium.Color.RED}
          });
        } 

      /* TO DO:

      1. Double clicking on a point displays orbit trajectory
      2. STATIONS = purple
         DEBRIS = red
        COMM sats = green
        NAV sats = blue
        SCIENCE sats = yellow
        WEATHER sats = yellow
      
      3. add search bar where you input name and it auto tracks to entity
          we have the names stored in array every 3rd element.
          if name  matches entity name, then we track onto target. 
          viewer.entities shows EntityCollection with AssociativeArray with all the names of entities
      */

      j += 3;

    }

    // Loading the globe and zooming out
    let initialized = false;
    viewer.scene.globe.tileLoadProgressEvent.addEventListener(() => {
      if (!initialized && viewer.scene.globe.tilesLoaded === true) {
        viewer.clock.shouldAnimate = true;
        initialized = true;
        viewer.scene.camera.zoomOut(7000000);
        document.querySelector("#loading").classList.toggle('disappear', true)
      }
    });


    // Clicking on a point displays the name of the entity in a text box, which tracks the entity as it
    // moves through space. This is achieved using a selectedEntity function that only triggers when an
    // entity is selected
    
    var testElement = document.createElement('div');
    viewer.selectedEntityChanged.addEventListener(function(selectedEntity) {
        if (Cesium.defined(selectedEntity)) {
          if (Cesium.defined(selectedEntity.name)) {
            // Create a sample HTML element in the document.
            testElement.style.position = 'absolute';
            testElement.style.border = '2px solid rgba(84, 84, 84, 1)';
            testElement.style.background = 'rgba(84, 84, 84, 1)';
            testElement.style.padding = '2px';
            testElement.style.boxShadow = '0 0 10px 1px #000';
            testElement.style.font = '13px sans-serif';
            testElement.style.fontWeight = 'normal';
            testElement.style.color = '#edffff';
            testElement.style.borderTopLeftRadius = '7px';
            testElement.style.borderBottomLeftRadius = '7px';
            testElement.style.borderTopRightRadius = '7px';
            testElement.style.borderBottomRightRadius = '7px';
            testElement.innerHTML = selectedEntity.name;
            viewer.container.appendChild(testElement);
            var isEntityVisible = true;

            var scratch3dPosition = new Cesium.Cartesian3();
            var scratch2dPosition = new Cesium.Cartesian2();

            // Every animation frame, update the HTML element position from the entity.
            viewer.clock.onTick.addEventListener(function(clock) {
              var position3d;
              var position2d;
              position3d = selectedEntity.position.getValue(clock.currentTime, scratch3dPosition);
              position2d = Cesium.SceneTransforms.wgs84ToWindowCoordinates(
                viewer.scene, position3d, scratch2dPosition);
              
              // Set the HTML position to match the entity's position.
              testElement.style.left = position2d.x + 'px';
              testElement.style.top = position2d.y + 'px'; 
            });
          }
        }
        else {
          testElement.remove(); // Remove contents of div after deselecting an entity
          console.log('Deselected');
        }
    });


  </script>

<!-- <table>
      <tr>
          <th>Name</th>
          <th>Apogee</th>
          <th>Perigee</th>
          <th>Type</th>
          <th>Color</th>
      </tr>
      <tr>
          <td>ISS</td>
          <td>422 km</td>
          <td>418 km</td>
          <td>Station</td>
          <td>Dark Magenta</td>
      </tr>
      <tr>
          <td>Starlink</td>
          <td></td>
          <td></td>
          <td>SATCOM</td>
          <td>White</td>
      </tr>
  </table>-->
  
</body>
</html>
