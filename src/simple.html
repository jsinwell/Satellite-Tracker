<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.js"></script>

  <!-- css -->
  <link rel="stylesheet" href="main.css" type="text/css" media="screen, projection" />
</head>
<body>
  <div id="loading">
   <h1>Satellite Visualizer</h1>
  </div>
  <div id="cesiumContainer"></div>

  <script src="TLE.js"> // Fill in an array with TLE data </script> 
  
  <script>
    // Initialize Cesium viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.TileMapServiceImageryProvider({
        url: Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII"),
      }),
      baseLayerPicker: false, geocoder: false, homeButton: true, infoBox: false,
      navigationHelpButton: false, sceneModePicker: true
    });

    viewer.scene.globe.enableLighting = true;

    var dataset_size = activeSattelites.length;
    var i = 0;

    console.log(activeSattelites);

    for(i=0; i < dataset_size; i+=2) {
      var tle1 = activeSattelites[i];
      var tle2 = activeSattelites[i+1];

      

      if(typeof tle1 == 'string' || typeof tle2 == 'string') {
        satrec = satellite.twoline2satrec(tle1, tle2);
      }


    // Give SatelliteJS the TLE's and a specific time.
    // Get back a longitude, latitude, height (km).
    // We're going to generate a position every 10 seconds from now until 6 seconds from now. 
            
      const totalSeconds = 21600;
      const timestepInSeconds = 10;
      const start = Cesium.JulianDate.fromDate(new Date());
      const stop = Cesium.JulianDate.addSeconds(start, totalSeconds, new Cesium.JulianDate());
      viewer.clock.startTime = start.clone();
      viewer.clock.stopTime = stop.clone();
      viewer.clock.currentTime = start.clone();
      viewer.timeline.zoomTo(start, stop);
      viewer.clock.multiplier = 40;
      viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
      
      const positionsOverTime = new Cesium.SampledPositionProperty();
      for (let i = 0; i < totalSeconds; i+= timestepInSeconds) {
        const time = Cesium.JulianDate.addSeconds(start, i, new Cesium.JulianDate());
        const jsDate = Cesium.JulianDate.toDate(time);

        const positionAndVelocity = satellite.propagate(satrec, jsDate);
        const gmst = satellite.gstime(jsDate);
        const p = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

        const position = Cesium.Cartesian3.fromRadians(p.longitude, p.latitude, p.height * 1000);
        positionsOverTime.addSample(time, position);
      }

      
      if(i <= 1) { // Making the ISS as a blue dot
         const satellitePoint = viewer.entities.add({
            position: positionsOverTime,
            point: { pixelSize: 4, color: Cesium.Color.DARKMAGENTA}
          });
      }

      else if (i > 1 && i <= 264) { // Starlink satellites show up as white dots
        const satellitePoint = viewer.entities.add({
        position: positionsOverTime,
        point: { pixelSize: 4, color: Cesium.Color.WHITE}
        });
      }

      else {
        const satellitePoint = viewer.entities.add({
        position: positionsOverTime,
        point: { pixelSize: 4, color: Cesium.Color.RED}
        });
      }
    

      /* TO DO:

      1. Double clicking on a point displays orbit trajectory and name
      2. add all starlinks, space stations, comm sattelites

      */

    }
    



    // Loading the globe and zooming out
    let initialized = false;
    viewer.scene.globe.tileLoadProgressEvent.addEventListener(() => {
      if (!initialized && viewer.scene.globe.tilesLoaded === true) {
        viewer.clock.shouldAnimate = true;
        initialized = true;
        viewer.scene.camera.zoomOut(7000000);
        document.querySelector("#loading").classList.toggle('disappear', true)
      }
    });

  </script>

  <table>
      <tr>
          <th>Name</th>
          <th>Apogee</th>
          <th>Perigee</th>
          <th>Type</th>
          <th>Color</th>
      </tr>
      <tr>
          <td>ISS</td>
          <td>422 km</td>
          <td>418 km</td>
          <td>Station</td>
          <td>Dark Magenta</td>
      </tr>
  </table>
</body>
</html>
