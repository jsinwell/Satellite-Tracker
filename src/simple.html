<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.js"></script>

  <!-- css -->
  <link rel="stylesheet" href="infobox.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="main.css" type="text/css" media="screen, projection" />
</head>
<body>
  <div id="loading">
   <h1>Satellite Visualizer</h1>
  </div>
  <div id="cesiumContainer"></div>

  <script src="TLE.js"> // Fill in an array with TLE data </script> 
  
  <script>
    // Initialize Cesium viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.TileMapServiceImageryProvider({
        url: Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII"),
      }),
      baseLayerPicker: false, geocoder: false, homeButton: true, infoBox: true,
      navigationHelpButton: false, sceneModePicker: true
    });
    
    viewer.infoBox.frame.removeAttribute('sandbox');
    viewer.scene.globe.enableLighting = true;

    var dataset_size = activeSattelites.length;
    var i = 0;
    var j = 0; // Track name of elements in activeSatellites

    //console.log(activeSattelites); // Debugging purposes

    for(i=0; i < dataset_size; i+=3) { // Loop through each satellite's TLE
      var tle1 = activeSattelites[i+1];
      var tle2 = activeSattelites[i+2];

      if(typeof tle1 == 'string' || typeof tle2 == 'string') {
        var satrec = satellite.twoline2satrec(tle1, tle2); // Initialize satellite record
      }

    
      const totalSeconds = 7200; // Sample points up to 8 hours from current date
      const timestepInSeconds = 10; // Generate a new position every 10 seconds
      const start = Cesium.JulianDate.fromDate(new Date());
      const stop = Cesium.JulianDate.addSeconds(start, totalSeconds, new Cesium.JulianDate());
      viewer.clock.startTime = start.clone();
      viewer.clock.stopTime = stop.clone();
      viewer.clock.currentTime = start.clone();
      viewer.timeline.zoomTo(start, stop);
      viewer.clock.multiplier = 20;
      viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
      
      const positionsOverTime = new Cesium.SampledPositionProperty();
      
      // Give SatelliteJS the TLE's and a specific time.
      // Get back a longitude, latitude, height (km).
      for (let i = 0; i < totalSeconds; i+= timestepInSeconds) {
        const time = Cesium.JulianDate.addSeconds(start, i, new Cesium.JulianDate());
        const jsDate = Cesium.JulianDate.toDate(time);

        const positionAndVelocity = satellite.propagate(satrec, jsDate);
        const gmst = satellite.gstime(jsDate);
        const p = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

        const position = Cesium.Cartesian3.fromRadians(p.longitude, p.latitude, p.height * 1000);
        positionsOverTime.addSample(time, position);
      }

      
        if(j == 0) { // International Space Station
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { pixelSize: 3, color: Cesium.Color.DARKMAGENTA}
          });
        }

        else if(j >= 3 && j <= 5346) { // Starlink (Comm)
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { scaleByDistance: new Cesium.NearFarScalar(1.5e2, 0, 2.0e5, 10.0), pixelSize: 3, color: Cesium.Color.GREEN}
          });
        }

       /* else if(j >= 5349 && j <= 5529) { // Space & Earth Science
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { "scaleByDistance": { "nearFarScalar": [ 1.0, 2.0, 10000.0, 3.0 ] }, pixelSize: 3, color: Cesium.Color.YELLOW}
          });
        }

        else if(j >= 5532 && j <= 6486) { // IRIDIUM 33 Debris
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { "scaleByDistance": { "nearFarScalar": [ 1.0, 2.0, 10000.0, 3.0 ] }, pixelSize: 3, color: Cesium.Color.RED}
          });
        }

        else if(j >= 6489 && j <= 6960) { // GNSS (Global Navigation Satellite Systems)
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { "scaleByDistance": { "nearFarScalar": [ 1.0, 2.0, 10000.0, 3.0 ] }, pixelSize: 3, color: Cesium.Color.DODGERBLUE}
          });
        }

        else if(j >= 6963 && j <= 14883) { // FENGYUN 1C Debris
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { "scaleByDistance": { "nearFarScalar": [ 1.0, 2.0, 10000.0, 3.0 ] }, pixelSize: 3, color: Cesium.Color.RED}
          });
        }

        else if(j >= 14886 && j <= 15201) { // Iridium & Iridium NEXT (Comm)
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { "scaleByDistance": { "nearFarScalar": [ 1.0, 2.0, 10000.0, 3.0 ] }, pixelSize: 3, color: Cesium.Color.GREEN}
          });
        }

        else if(j >= 15204 && j <= 18036) { // GEO Protected Zone (Comm)
          const satellitePoint = viewer.entities.add({
            name: activeSattelites[j],
            position: positionsOverTime,
            point: { "scaleByDistance": { "nearFarScalar": [ 1.0, 2.0, 10000.0, 3.0 ] }, pixelSize: 3, color: Cesium.Color.GREEN}
          });
        } */

      



    

      /* TO DO:

      1. Double clicking on a point displays orbit trajectory
      2. STATIONS = purple
         DEBRIS = red
        COMM sats = green
        NAV sats = blue
        SCIENCE sats = yellow
        WEATHER sats = yellow
      
      3. zooming out scales the points so it doesn't look weird
      */

      j += 3;

    }

    // Double clicking on a point displays the name of the entity, 
    // e.g. ISS in console for debugging purposes
    viewer.selectedEntityChanged.addEventListener(function(selectedEntity) {
      if (Cesium.defined(selectedEntity)) {
        if (Cesium.defined(selectedEntity.name)) {
          console.log('Selected ' + selectedEntity.name);
        }
      }
      else {
        console.log('Deselected');
      }
    });

    // Loading the globe and zooming out
    let initialized = false;
    viewer.scene.globe.tileLoadProgressEvent.addEventListener(() => {
      if (!initialized && viewer.scene.globe.tilesLoaded === true) {
        viewer.clock.shouldAnimate = true;
        initialized = true;
        viewer.scene.camera.zoomOut(7000000);
        document.querySelector("#loading").classList.toggle('disappear', true)
      }
    });

  </script>

  <table>
      <tr>
          <th>Name</th>
          <th>Apogee</th>
          <th>Perigee</th>
          <th>Type</th>
          <th>Color</th>
      </tr>
      <tr>
          <td>ISS</td>
          <td>422 km</td>
          <td>418 km</td>
          <td>Station</td>
          <td>Dark Magenta</td>
      </tr>
      <tr>
          <td>Starlink</td>
          <td></td>
          <td></td>
          <td>SATCOM</td>
          <td>White</td>
      </tr>
  </table>
  
</body>
</html>
