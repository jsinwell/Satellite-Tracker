<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.81/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.js"></script>

  <!-- css -->
  <link rel="stylesheet" href="main.css" type="text/css" media="screen, projection" />
</head>
<body>
  <div id="loading">
   <h1>Satellite Visualizer</h1>
  </div>
  <div id="cesiumContainer"></div>
  <script>
    // Initialize Cesium viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProvider: new Cesium.TileMapServiceImageryProvider({
        url: Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII"),
      }),
      baseLayerPicker: false, geocoder: false, homeButton: true, infoBox: false,
      navigationHelpButton: false, sceneModePicker: true
    });

    viewer.scene.globe.enableLighting = true;

    var activeSattelites = [     // NORAD TLE data collected from Celestrak "https://celestrak.com/NORAD/elements/"
    // ISS
    "1 25544U 98067A   22035.11888389  .00005478  00000+0  10475-3 0  9991",
    "2 25544  51.6440 275.5776 0006794  96.0673  63.4044 15.49756702324543",
    // STARLINK-1782           
    "1 47548U 21009A   22034.62116189  .00001691  00000+0  13243-3 0  9997",
    "2 47548  53.0533 243.2526 0001595  66.9516 293.1641 15.06398604 55598",
    // STARLINK-1806           
    "1 47549U 21009B   22034.75017005  .00002041  00000+0  15591-3 0  9997",
    "2 47549  53.0550 242.6680 0001625  74.6141 285.5027 15.06395510 55615",
    // STARLINK-1909           
    "1 47550U 21009C   22034.82849924 -.00000407  00000+0 -84495-5 0  9997",
    "2 47550  53.0543 232.3220 0001703  76.1038 284.0140 15.06391636 55765",
    // STARLINK-1938           
    "1 47551U 21009D   22034.88930941  .00003430  00000+0  24897-3 0  9999",
    "2 47551  53.0535 252.0381 0001634  70.7032 289.4133 15.06408215 55494",
    // STARLINK-1940           
    "1 47552U 21009E   22034.69488130  .00001795  00000+0  13936-3 0  9991",
    "2 47552  53.0540 242.9158 0001635  72.2575 287.8592 15.06399641 55607",
    // STARLINK-1951           
    "1 47553U 21009F   22034.88663487  .00281445  00000+0  47835-2 0  9999",
    "2 47553  53.0525 228.7629 0002110  51.6563 308.4635 15.49923096 55829",
    // STARLINK-1953           
    "1 47554U 21009G   22034.89943949  .00001797  00000+0  13949-3 0  9995",
    "2 47554  53.0556 261.9981 0001398  87.2999 272.8150 15.06409072 55359",
    // STARLINK-1954           
    "1 47555U 21009H   22034.60918356  .00000328  00000+0  40923-4 0  9991",
    "2 47555  53.0533 253.2972 0001662  71.8511 288.2658 15.06395611 55450",
    // STARLINK-1955           
    "1 47556U 21009J   22034.37882151  .00007006  00000+0  48864-3 0  9990",
    "2 47556  53.0532 274.3246 0002050  65.6440 294.4762 15.06410493 55138",
    // STARLINK-1956           
    "1 47557U 21009K   22034.87272697  .00001522  00000+0  12110-3 0  9996",
    "2 47557  53.0533 272.1230 0001929  63.1412 296.9774 15.06396403 55218",
    // STARLINK-1957           
    "1 47558U 21009L   22034.85337042  .00000855  00000+0  76328-4 0  9991",
    "2 47558  53.0563 242.1979 0002013  67.7561 292.3641 15.06402518 55622",
    // STARLINK-1958           
    "1 47559U 21009M   22034.88378254  .00000750  00000+0  69236-4 0  9999",
    "2 47559  53.0537 232.0641 0001928  71.2923 288.8275 15.06402156 55771",
    // STARLINK-1959           
    "1 47560U 21009N   22034.87641056  .00000501  00000+0  52561-4 0  9990",
    "2 47560  53.0530 232.1068 0001645  72.7411 287.3757 15.06402927 55779",
    // STARLINK-1960           
    "1 47561U 21009P   22034.73081124  .00001924  00000+0  14802-3 0  9995",
    "2 47561  53.0540 252.7618 0000905 123.9807 236.1268 15.06399945 55477",
    // STARLINK-1961           
    "1 47562U 21009Q   22034.87825473  .00001750  00000+0  13636-3 0  9995",
    "2 47562  53.0519 252.0963 0001926  63.0520 297.0665 15.06398695 55490",
    // STARLINK-1962           
    "1 47563U 21009R   22034.63499044  .00000080  00000+0  24311-4 0  9999",
    "2 47563  53.0533 253.1889 0002097  53.8743 306.2440 15.06395412 55454",
    // STARLINK-1963           
    "1 47564U 21009S   22034.83493591 -.00004095  00000+0 -25635-3 0  9994",
    "2 47564  53.0551 242.2914 0001575  69.6156 290.5002 15.06374919 55623",
    // STARLINK-1964           
    "1 47565U 21009T   22034.56587841  .00001599  00000+0  12624-3 0  9995",
    "2 47565  53.0550 243.4967 0001690  63.7079 296.4084 15.06391709 55587",
    // STARLINK-1965           
    "1 47566U 21009U   22034.82483267  .00004044  00000+0  29011-3 0  9998",
    "2 47566  53.0534 232.3273 0001962  71.4866 288.6336 15.06416115 55761",
    // STARLINK-1966           
    "1 47567U 21009V   22034.92800335  .00002998  00000+0  22002-3 0  9998",
    "2 47567  53.0554 271.8753 0001757  59.4497 300.6666 15.06410817 55217",
    // STARLINK-1967           
    "1 47568U 21009W   22034.88745950  .00002957  00000+0  21725-3 0  9991",
    "2 47568  53.0527 272.0494 0001897  69.7180 290.4012 15.06410316 55216",
    // STARLINK-1968           
    "1 47569U 21009X   22034.79074979  .00006920  00000+0  16821-3 0  9993",
    "2 47569  53.0525 225.0078 0003084  17.0792 343.0316 15.42182085 55879"];

    var dataset_size = activeSattelites.length;
    var i = 0;

    for(i=0; i < dataset_size; i+=2) {
      var tle1 = activeSattelites[i];
      var tle2 = activeSattelites[i+1];

      console.log(tle1);
      console.log(tle2);

      if(typeof tle1 == 'string' || typeof tle2 == 'string') {
        satrec = satellite.twoline2satrec(tle1, tle2);
      }


    // Give SatelliteJS the TLE's and a specific time.
    // Get back a longitude, latitude, height (km).
    // We're going to generate a position every 10 seconds from now until 6 seconds from now. 
            
      const totalSeconds = 21600;
      const timestepInSeconds = 10;
      const start = Cesium.JulianDate.fromDate(new Date());
      const stop = Cesium.JulianDate.addSeconds(start, totalSeconds, new Cesium.JulianDate());
      viewer.clock.startTime = start.clone();
      viewer.clock.stopTime = stop.clone();
      viewer.clock.currentTime = start.clone();
      viewer.timeline.zoomTo(start, stop);
      viewer.clock.multiplier = 40;
      viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
      
      const positionsOverTime = new Cesium.SampledPositionProperty();
      for (let i = 0; i < totalSeconds; i+= timestepInSeconds) {
        const time = Cesium.JulianDate.addSeconds(start, i, new Cesium.JulianDate());
        const jsDate = Cesium.JulianDate.toDate(time);

        const positionAndVelocity = satellite.propagate(satrec, jsDate);
        const gmst = satellite.gstime(jsDate);
        const p = satellite.eciToGeodetic(positionAndVelocity.position, gmst);

        const position = Cesium.Cartesian3.fromRadians(p.longitude, p.latitude, p.height * 1000);
        positionsOverTime.addSample(time, position);
      }

      
      if(i <= 1) { // Making the ISS as a blue dot
         const satellitePoint = viewer.entities.add({
            position: positionsOverTime,
            point: { pixelSize: 3, color: Cesium.Color.BLUE}
          });
      }

      else {
        const satellitePoint = viewer.entities.add({
        position: positionsOverTime,
        point: { pixelSize: 3, color: Cesium.Color.RED}
        });
      }

    }
    



    // Loading the globe and zooming out
    let initialized = false;
    viewer.scene.globe.tileLoadProgressEvent.addEventListener(() => {
      if (!initialized && viewer.scene.globe.tilesLoaded === true) {
        viewer.clock.shouldAnimate = true;
        initialized = true;
        viewer.scene.camera.zoomOut(7000000);
        document.querySelector("#loading").classList.toggle('disappear', true)
      }
    });

  </script>

  <table>
      <tr>
          <th>Name</th>
          <th>Apogee</th>
          <th>Perigee</th>
          <th>Type</th>
          <th>Color</th>
      </tr>
      <tr>
          <td>ISS</td>
          <td>422 km</td>
          <td>418 km</td>
          <td>Station</td>
          <td>Dark Blue</td>
      </tr>
  </table>
   
</body>
</html>